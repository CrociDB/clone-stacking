;; title:   Clone Stacking
;; author:  crocidb
;; desc:    figure out a way to leave the world by summoning clones
;; site:    https://crocidb.com/
;; license: MIT License (change this to your license of choice)
;; version: 0.1
;; script:  fennel
;; strict:  true

(var time 0)

;; LIB FUNCTIONS

;; Sprite
(fn sprite-create [idlist speed basecolor]
  {:idlist idlist :speed speed :basecolor basecolor})

(fn sprite-draw [animsprite x y]
  (let [current-sprite (. animsprite.idlist (+ 1 (% (// time animsprite.speed) (length animsprite.idlist))))]
    (spr current-sprite x y 0 animsprite.basecolor 0 0 2 2)))

;; Entity
(fn entity-create [x y spritelist]
  {:x x :y y :sprites spritelist :sprite 1})

(fn entity-draw [entity]
   (sprite-draw (. entity.sprites entity.sprite) entity.x entity.y))

;; Map
(fn map-create [mx my player goal]
  {:mx mx :my my :player player :goal goal})

(fn map-draw [m]
  (map m.mx m.my 30 17 0 0 1 1 nil))

;; GAME STATES

(var game {:update (fn [])})

;; Game

(var player-entity (entity-create 0 0 [(sprite-create [288 290] 15 1)
                                               (sprite-create [292 294] 15 1)
                                               (sprite-create [296 298] 15 1)
                                               (sprite-create [300 302] 15 1)]))

(var stategame {:data {} :reset (fn []) :update (fn [])})

(fn player-create [mx my entity]
  {:mx mx :my my :entity entity :state 0})

(fn player-move-to [p dir]
  (var mx p.mx)
  (var my p.my)

  (if (= dir :UP)   (set my (- my 2))
      (= dir :DOWN)  (set my (+ my 2))
      (= dir :LEFT)  (set mx (- mx 2))
      (= dir :RIGHT)  (set mx (+ mx 2)))

  (set p.mx mx)
  (set p.my my))

(fn player-update [p m]
  (set p.entity.x (* p.mx 8))
  (set p.entity.y (* p.my 8))
  
  (if (= p.state 0)
    (let []
      (when (btnp 0) (player-move-to p :UP))
      (when (btnp 1) (player-move-to p :DOWN))
      (when (btnp 2) (player-move-to p :LEFT))
      (when (btnp 3) (player-move-to p :RIGHT)))
  ))

(fn player-draw [p]
  (entity-draw p.entity))

(set stategame.data.map (map-create 0 0 {:x 8 :y 8 } {:x 19 :y 8}))
(set stategame.data.player (player-create stategame.data.map.player.x stategame.data.map.player.y player-entity))

(set stategame.update (fn []
  (cls 0)

  (player-update stategame.data.player stategame.data.map)

  (map-draw stategame.data.map)  
  (player-draw stategame.data.player)))

;; INITIALIZATION 

(set game.update stategame.update)

(fn _G.TIC []
  (set time (+ time 1))
  (game.update))

;; <TILES>
;; 002:00ffffff0fe44444fe444444f4444444f4444444f4444444f4444444f4444444
;; 003:ffffff0044444ef0444444ef4444444f4444444f4444444f4444444f4444444f
;; 004:00ffffff0fe44444fe444444f4444444f4444444f4444444f4444444f4444422
;; 005:ffffff0044444ef0444444ef4444444f4444444f4444444f4444444f3344444f
;; 006:00ffffff0f444444f4fffffff4f44444f4f44111f4f41000f4f41000f4f41000
;; 007:ffffff00444444f0ffffff4f44444f4f11144f4f00014f4f00014f4f00014f4f
;; 008:00ffffff0fe44444fe444444f4444444f4444477f4447766f4476666f4447766
;; 009:ffffff0044444ef0444444ef7774444f6674444f6674444f6674444f6674444f
;; 018:f4444444f4444444f4444444f4444444f4444444fe4444440fe4444400ffffff
;; 019:4444444f4444444f4444444f4444444f4444444f444444ef44444ef0ffffff00
;; 020:f4444222f4442222f4444222f4444122fd4444110e4444440fed444400ffffff
;; 021:2234444f2223444f2224444f2214444f1144444f444444e044444ef0ffffff00
;; 022:f4f41000f4f41000f4f41000f4f44111f4f44444f4ffffff0f44444400ffffff
;; 023:00014f4f00014f4f00014f4f11144f4f44444f4fffffff4f444444f0ffffff00
;; 024:f4444477f4444444f4444444f4444444f4444444fe4444440fe4444400ffffff
;; 025:6674444f7774444f4474444f4474444f4474444f444444ef44444ef0ffffff00
;; </TILES>

;; <SPRITES>
;; 032:000000000000ff00000fdcf000fdddcf000fddf00000ffdf0000fddd000fdddd
;; 033:0000000000000000000000000000000000000000fff00000ddcf0000dddcf000
;; 034:0000ff00000fdcf000fdddcf000fddf00000ffdf0000fddd000fdddd00fddd2d
;; 035:00000000000000000000000000000000fff00000ddcf0000dddcf000d2ddcf00
;; 036:0000000000000000000000000000000f0000000000000fff0000fddd000fdddd
;; 037:000000000ff00000fdcf0000dddcf000fddf0000fff00000ddcf0000dddcf000
;; 038:00000000000000000000000f0000000000000fff0000fddd000fdddd00fddddd
;; 039:0ff00000fdcf0000dddcf000fddf0000fff00000ddcf0000dddcf000dd2dcf00
;; 040:000000000000ff00000fdcf000fdddcf000fddf00000ffdf0000fddd000fdddd
;; 041:0000000000000000000000000000000000000000fff00000ddcf0000dddcf000
;; 042:0000ff00000fdcf000fdddcf000fddf00000ffdf0000fddd000fdddd00fdd2dd
;; 043:00000000000000000000000000000000fff00000ddcf0000dddcf000ddddcf00
;; 044:0000000000000000000000000000000f0000000000000fff0000fddd000fdddd
;; 045:000000000ff00000fdcf0000dddcf000fddf0000fff00000ddcf0000dddcf000
;; 046:00000000000000000000000f0000000000000fff0000fddd000fdddd00fddddd
;; 047:0ff00000fdcf0000dddcf000fddf0000fff00000ddcf0000dddcf000ddddcf00
;; 048:00fddd2d00fddddd00fedded000fedde0000fedd00000fff0000000000000000
;; 049:d2ddcf00dddddf00dddddf00eeddf000dddf0000fff000000000000000000000
;; 050:00fddddd00fddddd00fedded000fedde0000fedd00000fff0000000000000000
;; 051:dddddf00dddddf00dddddf00eeddf000dddf0000fff000000000000000000000
;; 052:00fddddd00fddddd00fedddd000feddd0000fedd00000fff0000000000000000
;; 053:dd2dcf00dddddf00ddeddf00dddef000dddf0000fff000000000000000000000
;; 054:00fddddd00fddddd00fedddd000feddd0000fedd00000fff0000000000000000
;; 055:dddddf00dddddf00ddeddf00dddef000dddf0000fff000000000000000000000
;; 056:00fdd2dd00fddddd00fedddd000feeed0000fedd00000fff0000000000000000
;; 057:ddddcf00dddddf00dddddf00dddef000dddf0000fff000000000000000000000
;; 058:00fddddd00fddddd00fedddd000feeed0000fedd00000fff0000000000000000
;; 059:dddddf00dddddf00dddddf00dddef000dddf0000fff000000000000000000000
;; 060:00fddddd00fddddd00feddde000feddd0000fedd00000fff0000000000000000
;; 061:ddddcf00eddddf00dddddf00ddddf000dddf0000fff000000000000000000000
;; 062:00fddddd00fddddd00feddde000feddd0000fedd00000fff0000000000000000
;; 063:dddddf00eddddf00dddddf00ddddf000dddf0000fff000000000000000000000
;; </SPRITES>

;; <MAP>
;; 006:000000000000000020302030203000002030203020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
;; 007:000000000000000021312131213100002131213121310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
;; 008:000000000000000020302030203000002030203080900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
;; 009:000000000000000021312131213100002131213181910000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
;; 010:000000000000000020302030203000002030203020300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
;; 011:000000000000000021312131213100002131213121310000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
;; </MAP>

;; <WAVES>
;; 000:00000000ffffffff00000000ffffffff
;; 001:0123456789abcdeffedcba9876543210
;; 002:0123456789abcdef0123456789abcdef
;; </WAVES>

;; <SFX>
;; 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
;; </SFX>

;; <TRACKS>
;; 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
;; </TRACKS>

;; <PALETTE>
;; 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
;; </PALETTE>

